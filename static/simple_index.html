<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üßÆ Alice Training HUD</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; color: white; padding: 20px;
        }
        .header {
            text-align: center; margin-bottom: 30px;
            background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .stats { display: flex; justify-content: center; gap: 30px; margin-top: 15px; }
        .stat-item { text-align: center; }
        .stat-number { font-size: 2em; font-weight: bold; color: #00ff88; }
        .main-content { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .progress-section { grid-column: 1 / -1; margin-bottom: 20px; }
        @media (max-width: 768px) { .main-content { grid-template-columns: 1fr; } }
        .panel {
            background: rgba(255,255,255,0.1); border-radius: 15px; padding: 20px;
            backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);
        }
        .panel h2 { margin-bottom: 15px; color: #00ff88; }
        .session-card {
            background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;
            border-left: 4px solid #00ff88; margin-bottom: 15px;
        }
        .session-card.running { border-left-color: #00ff88; }
        .session-card.starting { border-left-color: #ffaa00; }
        .session-card.completed { border-left-color: #0088ff; }
        .session-card.failed { border-left-color: #ff4444; }
        .session-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .session-name { font-weight: bold; font-size: 1.1em; }
        .session-status { padding: 4px 12px; border-radius: 20px; font-size: 0.8em; font-weight: bold; }
        .status-running { background: #00ff88; color: black; animation: pulse 2s infinite; }
        .status-starting { background: #ffaa00; color: black; }
        .status-completed { background: #0088ff; color: white; }
        .status-failed { background: #ff4444; color: white; }
        .chat-panel { height: 300px; overflow-y: auto; font-family: Monaco, monospace; font-size: 0.85em; }
        .log-panel { height: 300px; overflow-y: auto; font-family: Monaco, monospace; font-size: 0.8em; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; }
        .chat-message { padding: 8px 12px; border-radius: 8px; margin-bottom: 5px; line-height: 1.4; }
        .log-line { margin-bottom: 3px; line-height: 1.3; }
        .log-line.success { color: #00ff88; }
        .log-line.error { color: #ff6b6b; }
        .log-line.warning { color: #ffd93d; }
        .log-line.info { color: #ffffff; opacity: 0.8; }
        .chat-message.info { background: rgba(255,255,255,0.1); }
        .chat-message.success { background: rgba(0,255,136,0.2); }
        .chat-message.warning { background: rgba(255,170,0,0.2); }
        .chat-message.error { background: rgba(255,68,68,0.2); }
        .controls { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 20px; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin: 5px; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); }
        .btn-primary { background: #00ff88; color: black; }
        .btn-primary:hover { background: #00cc6a; }
        .btn-danger { background: #ff4444; color: white; }
        .btn-danger:hover { background: #cc3333; }
        .btn-secondary { background: #0088ff; color: white; }
        .btn-secondary:hover { background: #0066cc; }
        .auto-refresh { position: fixed; top: 20px; right: 20px; background: #00ff88; color: black; padding: 10px; border-radius: 8px; }
        .progress-chart { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 20px; }
        .chart-container { position: relative; height: 200px; margin-top: 15px; }
        .chart-svg { width: 100%; height: 100%; }
        .chart-line { fill: none; stroke: #00ff88; stroke-width: 2; }
        .chart-area { fill: rgba(0,255,136,0.1); }
        .chart-dot { fill: #00ff88; stroke: #fff; stroke-width: 2; r: 4; }
        .chart-axis { stroke: rgba(255,255,255,0.3); stroke-width: 1; }
        .chart-text { fill: rgba(255,255,255,0.7); font-size: 12px; }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
        .metric-card { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; text-align: center; }
        .metric-value { font-size: 1.8em; font-weight: bold; color: #00ff88; }
        .metric-label { font-size: 0.9em; opacity: 0.8; }
        .metric-change { font-size: 0.8em; margin-top: 5px; }
        .metric-up { color: #00ff88; }
        .metric-down { color: #ff6b6b; }
        .metric-neutral { color: #ffd93d; }
        .training-status {
            background: rgba(0,0,0,0.4); padding: 15px; border-radius: 10px; margin-bottom: 15px;
            border-left: 4px solid #00ff88;
        }
        .training-status.idle { border-left-color: #666; }
        .training-status.running { border-left-color: #00ff88; }
        .training-status.error { border-left-color: #ff4444; }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="auto-refresh" id="refreshStatus">üîÑ Auto-refresh: ON</div>
    
    <div class="header">
        <h1>üßÆ Alice Training HUD</h1>
        <p>Enkel real-time tr√§ningsmonitoring</p>
        <div class="stats">
            <div class="stat-item">
                <div class="stat-number" id="activeSessions">0</div>
                <div>Aktiva</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalSessions">0</div>
                <div>Totalt</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalMessages">0</div>
                <div>Meddelanden</div>
            </div>
        </div>
    </div>
    
    <div class="progress-section">
        <div class="progress-chart">
            <h2>üìà Tr√§ningsprogress</h2>
            <div class="chart-container">
                <svg class="chart-svg" id="progressChart">
                    <!-- Progress chart will be drawn here -->
                </svg>
            </div>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="avgResponseTime">0ms</div>
                    <div class="metric-label">Genomsnittlig svarstid</div>
                    <div class="metric-change" id="responseTimeChange"></div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="cacheHitRate">0%</div>
                    <div class="metric-label">Cache tr√§ffar</div>
                    <div class="metric-change" id="cacheHitChange"></div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="successRate">0%</div>
                    <div class="metric-label">Framg√•ng</div>
                    <div class="metric-change" id="successRateChange"></div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="fibonacciEfficiency">œÜ 0.00</div>
                    <div class="metric-label">Fibonacci-effektivitet</div>
                    <div class="metric-change" id="fibonacciChange"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="main-content">
        <div class="panel">
            <h2>üéÆ Tr√§ningsstatus</h2>
            <div class="training-status idle" id="trainingStatus">
                <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px;">‚ö™ Ingen tr√§ning aktiv</div>
                <div style="opacity: 0.8;">Klicka p√• en av knapparna nedan f√∂r att starta ett test.</div>
            </div>
            <div class="controls">
                <h3 style="margin-bottom: 15px;">üéØ Test Kontroller</h3>
                <button class="btn btn-primary" onclick="startTraining('fibonacci')">üßÆ Starta Fibonacci</button>
                <button class="btn btn-primary" onclick="startTraining('fibonacci_loop')">üîÑ Starta Loop</button>
                <br>
                <button class="btn btn-danger" onclick="stopAllTraining()">‚èπÔ∏è Stoppa Test</button>
                <button class="btn btn-secondary" onclick="clearChat()">üßπ Rensa Chat</button>
                <button class="btn btn-secondary" onclick="runSystemCheck()">üîç Systemkontroll</button>
            </div>
        </div>
        
        <div class="panel">
            <h2>üí¨ Live Chat</h2>
            <div id="chatContainer" class="chat-panel">
                <div class="chat-message info">
                    <strong>SYSTEM:</strong> üéØ V√§lkommen! Starta tr√§ning f√∂r att se live-uppdateringar.
                </div>
            </div>
        </div>
        
        <div class="panel">
            <h2>üìú Script Logg</h2>
            <div id="logContainer" class="log-panel">
                <div class="log-line info">üí° Scriptlogg visas h√§r n√§r test k√∂rs...</div>
            </div>
        </div>
    </div>
    
    <div class="panel">
        <h2>üìä Aktiva Sessioner</h2>
        <div id="sessionsContainer">
            <div style="text-align: center; opacity: 0.5; padding: 20px;">
                Inga aktiva sessioner.
            </div>
        </div>
    </div>
    
    <div class="controls">
        <h2>üéõÔ∏è Avancerade Kontroller</h2>
        <button class="btn btn-secondary" onclick="cleanupFailedSessions()">üóëÔ∏è Rensa Failed</button>
        <button class="btn btn-secondary" onclick="toggleAutoRefresh()">‚è∏Ô∏è Pausa Refresh</button>
        <button class="btn btn-secondary" onclick="testMultipleTraining()">üî¨ Test Flera Samtidigt</button>
    </div>

    <script>
        let sessions = {};
        let autoRefresh = true;
        let refreshInterval;
        
        async function startTraining(trainingType) {
            try {
                const response = await fetch('/api/start-training', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ training_type: trainingType })
                });
                const result = await response.json();
                if (!result.success) {
                    alert('Fel vid start: ' + result.error);
                }
            } catch (error) {
                alert('Fel: ' + error.message);
            }
        }
        
        async function stopAllTraining() {
            if (!confirm('Stoppa alla tr√§ningar?')) return;
            try {
                const response = await fetch('/api/stop-all', { method: 'POST' });
                const result = await response.json();
                alert(`Stoppade ${result.stopped_count} tr√§ningar`);
            } catch (error) {
                alert('Fel: ' + error.message);
            }
        }
        
        function clearChat() {
            document.getElementById('chatContainer').innerHTML = `
                <div class="chat-message info">
                    <strong>SYSTEM:</strong> Chat rensad.
                </div>
            `;
            document.getElementById('logContainer').innerHTML = `
                <div class="log-line info">üí° Scriptlogg rensad...</div>
            `;
        }
        
        async function testMultipleTraining() {
            if (!confirm('Detta kommer starta flera test samtidigt. √Ñr du s√§ker?')) return;
            
            try {
                // Start both training types simultaneously
                const response1 = fetch('/api/start-training', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ training_type: 'fibonacci' })
                });
                
                const response2 = fetch('/api/start-training', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ training_type: 'fibonacci_loop' })
                });
                
                const [result1, result2] = await Promise.all([response1, response2]);
                
                const data1 = await result1.json();
                const data2 = await result2.json();
                
                if (data1.success && data2.success) {
                    alert('üöÄ B√•da testen startade framg√•ngsrikt!');
                } else {
                    alert('‚ö†Ô∏è Ett eller b√•da testen kunde inte startas. Kolla loggen.');
                }
                
            } catch (error) {
                alert('‚ùå Fel vid simultant test: ' + error.message);
            }
        }
        
        async function cleanupFailedSessions() {
            if (!confirm('Rensa alla failed sessions fr√•n minnet?')) return;
            try {
                const response = await fetch('/api/cleanup-failed', { method: 'POST' });
                const result = await response.json();
                alert(`Rensade ${result.cleaned_count} failed sessions`);
                updateData(); // Uppdatera vyn
            } catch (error) {
                alert('Fel vid rensning: ' + error.message);
            }
        }
        
        async function runSystemCheck() {
            try {
                // Visa att kontroll p√•g√•r
                const chatContainer = document.getElementById('chatContainer');
                chatContainer.innerHTML += `
                    <div class="chat-message info">
                        <strong>SYSTEM:</strong> üîç K√∂r omfattande systemkontroll...
                    </div>
                `;
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                const response = await fetch('/api/system-status');
                const status = await response.json();
                
                // Visa resultatet i chatten
                let healthIcon = '‚úÖ';
                let healthColor = 'success';
                
                if (status.overall_health === 'critical') {
                    healthIcon = 'üî¥';
                    healthColor = 'error';
                } else if (status.overall_health === 'warning') {
                    healthIcon = '‚ö†Ô∏è';
                    healthColor = 'warning';
                }
                
                chatContainer.innerHTML += `
                    <div class="chat-message ${healthColor}">
                        <strong>SYSTEMSTATUS:</strong> ${healthIcon} ${status.overall_health.toUpperCase()}
                    </div>
                `;
                
                // Visa kritiska problem
                if (status.summary.critical_issues > 0) {
                    chatContainer.innerHTML += `
                        <div class="chat-message error">
                            <strong>KRITISKA PROBLEM:</strong> ${status.summary.critical_issues} st
                        </div>
                    `;
                }
                
                // Visa alerts
                status.alerts.slice(0, 5).forEach(alert => {
                    let alertColor = 'error';
                    if (alert.includes('VARNING')) alertColor = 'warning';
                    if (alert.includes('PROBLEM')) alertColor = 'warning';
                    
                    chatContainer.innerHTML += `
                        <div class="chat-message ${alertColor}">
                            <strong>ALERT:</strong> ${alert}
                        </div>
                    `;
                });
                
                // Visa rekommendationer
                if (status.recommendations.length > 0) {
                    chatContainer.innerHTML += `
                        <div class="chat-message info">
                            <strong>REKOMMENDATIONER:</strong>
                        </div>
                    `;
                    status.recommendations.slice(0, 3).forEach(rec => {
                        chatContainer.innerHTML += `
                            <div class="chat-message info">
                                <strong>‚Üí</strong> ${rec}
                            </div>
                        `;
                    });
                }
                
                if (status.overall_health === 'healthy') {
                    chatContainer.innerHTML += `
                        <div class="chat-message success">
                            <strong>RESULTAT:</strong> ‚úÖ Alla system fungerar korrekt!
                        </div>
                    `;
                }
                
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
            } catch (error) {
                const chatContainer = document.getElementById('chatContainer');
                chatContainer.innerHTML += `
                    <div class="chat-message error">
                        <strong>FEL:</strong> Kunde inte k√∂ra systemkontroll - ${error.message}
                    </div>
                `;
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }
        
        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh;
            const btn = event.target;
            const status = document.getElementById('refreshStatus');
            
            if (autoRefresh) {
                btn.textContent = '‚è∏Ô∏è Pausa Refresh';
                status.textContent = 'üîÑ Auto-refresh: ON';
                status.style.background = '#00ff88';
                startAutoRefresh();
            } else {
                btn.textContent = '‚ñ∂Ô∏è Starta Refresh';
                status.textContent = '‚è∏Ô∏è Auto-refresh: OFF';
                status.style.background = '#ff4444';
                clearInterval(refreshInterval);
            }
        }
        
        async function updateData() {
            try {
                // Uppdatera sessions
                const sessionsResponse = await fetch('/api/sessions');
                const sessionsData = await sessionsResponse.json();
                
                // Uppdatera meddelanden
                const messagesResponse = await fetch('/api/messages');
                const messagesData = await messagesResponse.json();
                
                renderSessions(sessionsData);
                renderMessages(messagesData);
                updateStats(sessionsData, messagesData);
                
            } catch (error) {
                console.error('Fel vid uppdatering:', error);
            }
        }
        
        function renderSessions(sessionsData) {
            const container = document.getElementById('sessionsContainer');
            
            // Filtrera bort failed sessions - visa bara running, starting, completed
            const activeSessions = sessionsData.filter(s => 
                s.status === 'running' || s.status === 'starting' || s.status === 'completed'
            );
            
            if (activeSessions.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; opacity: 0.5; padding: 40px;">
                        Inga aktiva tr√§ningar. Starta en nedan! üëá
                    </div>
                `;
                return;
            }
            
            container.innerHTML = activeSessions.map(session => `
                <div class="session-card ${session.status}">
                    <div class="session-header">
                        <div class="session-name">${session.name}</div>
                        <div class="session-status status-${session.status}">
                            ${session.status === 'running' ? '‚óè' : 
                              session.status === 'starting' ? '‚óê' : 
                              session.status === 'completed' ? '‚úì' : '‚úó'} 
                            ${session.status.toUpperCase()}
                        </div>
                    </div>
                    <div style="font-size: 0.9em; opacity: 0.8; margin-bottom: 5px;">
                        ${session.session_type}
                    </div>
                    <div style="font-size: 0.9em; opacity: 0.8; margin-bottom: 5px;">
                        ‚è±Ô∏è Uptime: ${session.uptime_display}
                    </div>
                    <div style="font-size: 0.9em; opacity: 0.8;">
                        üí¨ Meddelanden: ${session.message_count}
                    </div>
                </div>
            `).join('');
        }
        
        function renderMessages(messagesData) {
            const chatContainer = document.getElementById('chatContainer');
            const logContainer = document.getElementById('logContainer');
            
            if (messagesData.length === 0) return;
            
            // Chat messages (formatted)
            const chatHtml = messagesData.slice(-20).map(msg => `
                <div class="chat-message ${msg.level}">
                    <strong>${msg.time} [${msg.session}]:</strong> ${msg.message}
                </div>
            `).join('');
            
            chatContainer.innerHTML = chatHtml;
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Script log (raw output)
            const logHtml = messagesData.slice(-50).map(msg => `
                <div class="log-line ${msg.level}">
                    ${msg.time} ${msg.session}: ${msg.message}
                </div>
            `).join('');
            
            logContainer.innerHTML = logHtml;
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function updateStats(sessionsData, messagesData) {
            const activeCount = sessionsData.filter(s => 
                s.status === 'running' || s.status === 'starting'
            ).length;
            
            document.getElementById('activeSessions').textContent = activeCount;
            document.getElementById('totalSessions').textContent = sessionsData.length;
            document.getElementById('totalMessages').textContent = messagesData.length;
            
            // Update training status indicator
            updateTrainingStatus(sessionsData);
            
            // Uppdatera progress metrics
            updateProgressMetrics(sessionsData);
        }
        
        function updateTrainingStatus(sessionsData) {
            const statusContainer = document.getElementById('trainingStatus');
            const activeSessions = sessionsData.filter(s => s.status === 'running' || s.status === 'starting');
            
            if (activeSessions.length === 0) {
                statusContainer.className = 'training-status idle';
                statusContainer.innerHTML = `
                    <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px;">‚ö™ Ingen tr√§ning aktiv</div>
                    <div style="opacity: 0.8;">Klicka p√• en av knapparna nedan f√∂r att starta ett test.</div>
                `;
            } else {
                const session = activeSessions[0];
                statusContainer.className = 'training-status running';
                statusContainer.innerHTML = `
                    <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px;">üü¢ ${session.name} K√ñRS</div>
                    <div style="opacity: 0.8;">‚è±Ô∏è Tid: ${session.uptime_display} | üí¨ Meddelanden: ${session.message_count}</div>
                    <div style="margin-top: 10px; opacity: 0.9;">Cache: ${session.performance_stats.cache_hit_rate_percent.toFixed(1)}% | Success: ${session.performance_stats.success_rate_percent.toFixed(1)}%</div>
                `;
            }
        }
        
        let progressHistory = [];
        
        function updateProgressMetrics(sessionsData) {
            // Hitta den mest aktiva/senaste tr√§ningen
            const activeSessions = sessionsData.filter(s => s.status === 'running' || s.status === 'completed');
            
            if (activeSessions.length === 0) {
                // Nollst√§ll metrics om ingen aktiv tr√§ning
                document.getElementById('avgResponseTime').textContent = '0ms';
                document.getElementById('cacheHitRate').textContent = '0%';
                document.getElementById('successRate').textContent = '0%';
                document.getElementById('fibonacciEfficiency').textContent = 'œÜ 0.00';
                clearChart();
                return;
            }
            
            // Ta den senaste aktiva sessionen
            const session = activeSessions.sort((a, b) => 
                new Date(b.start_time) - new Date(a.start_time)
            )[0];
            
            const stats = session.performance_stats;
            
            // Uppdatera metric cards
            document.getElementById('avgResponseTime').textContent = 
                stats.avg_response_time_ms ? `${Math.round(stats.avg_response_time_ms)}ms` : '0ms';
            document.getElementById('cacheHitRate').textContent = 
                `${stats.cache_hit_rate_percent.toFixed(1)}%`;
            document.getElementById('successRate').textContent = 
                `${stats.success_rate_percent.toFixed(1)}%`;
            document.getElementById('fibonacciEfficiency').textContent = 
                `œÜ ${stats.fibonacci_efficiency.toFixed(3)}`;
            
            // L√§gg till i historik f√∂r graf
            const now = new Date();
            progressHistory.push({
                timestamp: now,
                cacheHitRate: stats.cache_hit_rate_percent,
                successRate: stats.success_rate_percent,
                responseTime: stats.avg_response_time_ms || 0,
                requests: stats.total_requests || 0
            });
            
            // Beh√•ll bara senaste 50 punkter
            if (progressHistory.length > 50) {
                progressHistory = progressHistory.slice(-50);
            }
            
            // Rita graf
            drawProgressChart();
            
            // Ber√§kna f√∂r√§ndringar (j√§mf√∂rt med f√∂reg√•ende)
            if (progressHistory.length > 1) {
                const prev = progressHistory[progressHistory.length - 2];
                const curr = progressHistory[progressHistory.length - 1];
                
                updateMetricChange('responseTimeChange', prev.responseTime, curr.responseTime, true); // true = lower is better
                updateMetricChange('cacheHitChange', prev.cacheHitRate, curr.cacheHitRate);
                updateMetricChange('successRateChange', prev.successRate, curr.successRate);
                
                // Fibonacci efficiency change
                const prevFib = 1.618033988749; // default
                const currFib = stats.fibonacci_efficiency;
                updateMetricChange('fibonacciChange', prevFib, currFib);
            }
        }
        
        function updateMetricChange(elementId, prevValue, currValue, lowerIsBetter = false) {
            const element = document.getElementById(elementId);
            const diff = currValue - prevValue;
            
            if (Math.abs(diff) < 0.01) {
                element.textContent = '‚Üí Stabil';
                element.className = 'metric-change metric-neutral';
                return;
            }
            
            const isImprovement = lowerIsBetter ? diff < 0 : diff > 0;
            const arrow = isImprovement ? '‚Üó' : '‚Üò';
            const className = isImprovement ? 'metric-up' : 'metric-down';
            
            element.textContent = `${arrow} ${Math.abs(diff).toFixed(1)}${elementId.includes('Rate') ? '%' : ''}`;
            element.className = `metric-change ${className}`;
        }
        
        function clearChart() {
            const svg = document.getElementById('progressChart');
            svg.innerHTML = '';
            progressHistory = [];
        }
        
        function drawProgressChart() {
            if (progressHistory.length < 2) return;
            
            const svg = document.getElementById('progressChart');
            const rect = svg.getBoundingClientRect();
            const width = rect.width;
            const height = rect.height;
            
            if (width === 0 || height === 0) return; // SVG not ready
            
            svg.innerHTML = ''; // Clear existing
            
            // Chart margins
            const margin = { top: 20, right: 20, bottom: 30, left: 40 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            
            // Find data ranges
            const maxCacheRate = Math.max(...progressHistory.map(d => d.cacheHitRate));
            const maxSuccessRate = Math.max(...progressHistory.map(d => d.successRate));
            const maxRate = Math.max(maxCacheRate, maxSuccessRate, 100);
            
            // Create scales
            const xScale = (i) => margin.left + (i / (progressHistory.length - 1)) * chartWidth;
            const yScale = (value) => margin.top + chartHeight - (value / maxRate) * chartHeight;
            
            // Draw axes
            svg.innerHTML += `<line x1="${margin.left}" y1="${margin.top}" x2="${margin.left}" y2="${margin.top + chartHeight}" class="chart-axis"/>`;
            svg.innerHTML += `<line x1="${margin.left}" y1="${margin.top + chartHeight}" x2="${margin.left + chartWidth}" y2="${margin.top + chartHeight}" class="chart-axis"/>`;
            
            // Draw cache hit rate line
            const cachePoints = progressHistory.map((d, i) => `${xScale(i)},${yScale(d.cacheHitRate)}`).join(' ');
            svg.innerHTML += `<polyline points="${cachePoints}" class="chart-line" stroke="#00ff88"/>`;
            
            // Draw success rate line
            const successPoints = progressHistory.map((d, i) => `${xScale(i)},${yScale(d.successRate)}`).join(' ');
            svg.innerHTML += `<polyline points="${successPoints}" class="chart-line" stroke="#0088ff"/>`;
            
            // Draw dots for latest points
            const latest = progressHistory[progressHistory.length - 1];
            const latestIndex = progressHistory.length - 1;
            svg.innerHTML += `<circle cx="${xScale(latestIndex)}" cy="${yScale(latest.cacheHitRate)}" class="chart-dot" fill="#00ff88"/>`;
            svg.innerHTML += `<circle cx="${xScale(latestIndex)}" cy="${yScale(latest.successRate)}" class="chart-dot" fill="#0088ff"/>`;
            
            // Add labels
            svg.innerHTML += `<text x="${margin.left + 10}" y="${margin.top + 15}" class="chart-text">Cache Hit Rate</text>`;
            svg.innerHTML += `<text x="${margin.left + 10}" y="${margin.top + 30}" class="chart-text" fill="#0088ff">Success Rate</text>`;
            
            // Y-axis labels
            svg.innerHTML += `<text x="${margin.left - 10}" y="${yScale(0)}" class="chart-text" text-anchor="end">0%</text>`;
            svg.innerHTML += `<text x="${margin.left - 10}" y="${yScale(maxRate)}" class="chart-text" text-anchor="end">${Math.round(maxRate)}%</text>`;
        }
        
        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                if (autoRefresh) updateData();
            }, 2000); // Uppdatera var 2:a sekund
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateData();
            startAutoRefresh();
        });
    </script>
</body>
</html>